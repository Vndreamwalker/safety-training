<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Đào tạo nhận diện mối nguy</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  padding:20px;
}
h1{text-align:center}
.subtitle{
  text-align:center;
  font-style:italic;
  margin-bottom:15px;
}

.video-wrapper{
  position:relative;
  width:800px;
  max-width:100%;
  margin:auto;
  border:3px solid #333;
  background:#000;
}

#player{
  width:100%;
  height:450px;
}

#overlay{
  position:absolute;
  inset:0;
  cursor:crosshair;
  display:none;
  z-index:10;
}

.correct-box{
  position:absolute;
  border:3px solid lime;
  background:rgba(0,255,0,0.25);
  z-index:15;
}

.wrong-mark{
  position:absolute;
  width:20px;
  height:20px;
  background:red;
  border-radius:50%;
  transform:translate(-50%,-50%);
  z-index:20;
}

.info,.result{
  text-align:center;
  margin-top:15px;
  font-size:18px;
  font-weight:bold;
}
</style>
</head>

<body>

<h1>Nhận diện mối nguy trong video</h1>
<div class="subtitle">
Video sẽ tạm dừng để người chơi xác định các mối nguy nhằm cứu nhân vật.  
If not enough hazards are identified, the accident will continue.
</div>

<div class="video-wrapper" id="videoBox">
  <div id="player"></div>
  <div id="overlay"></div>
</div>

<div class="info">
  Lượt chọn: <span id="clicks">0</span> / <span id="max">0</span> |
  Đúng: <span id="found">0</span>
</div>

<div class="result" id="result"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
const STOP_TIME = 30;

const hazardData = [
  { x:0.472, y:0.562, w:0.206, h:0.213 },
  { x:0.701, y:0.665, w:0.060, h:0.145 },
  { x:0.807, y:0.461, w:0.032, h:0.103 },
  { x:0.791, y:0.550, w:0.206, h:0.225 },
  { x:0.684, y:0.272, w:0.107, h:0.351 },
  { x:0.491, y:0.127, w:0.104, h:0.257 }
];

let clicks = 0;
let found = 0;
let evaluated = false;
let stopTriggered = false;

document.getElementById('max').innerText = hazardData.length;

function onYouTubeIframeAPIReady(){
  player = new YT.Player('player',{
    videoId:'fXYMaqxx2sY',
    playerVars:{ controls:1 },
    events:{ onStateChange:onState }
  });
}

function onState(e){
  if(e.data === YT.PlayerState.PLAYING){
    const timer = setInterval(()=>{
      if(!player || stopTriggered) return;

      if(player.getCurrentTime() >= STOP_TIME){
        stopTriggered = true;
        player.pauseVideo();
        document.getElementById('overlay').style.display='block';
        clearInterval(timer);
      }
    },300);
  }
}

document.getElementById('overlay').addEventListener('click',function(e){
  if(evaluated || clicks >= hazardData.length) return;

  clicks++;
  document.getElementById('clicks').innerText = clicks;

  const rect = this.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;

  let hit = false;

  hazardData.forEach(h=>{
    if(!h.selected &&
      x>=h.x && x<=h.x+h.w &&
      y>=h.y && y<=h.y+h.h){
        h.selected = true;
        hit = true;
        found++;
        document.getElementById('found').innerText = found;
        drawCorrect(h);
    }
  });

  if(!hit) drawWrong(x,y);

  if(clicks === hazardData.length || found === hazardData.length){
    evaluate();
  }
});

function drawCorrect(h){
  const d=document.createElement('div');
  d.className='correct-box';
  d.style.left=(h.x*100)+'%';
  d.style.top =(h.y*100)+'%';
  d.style.width=(h.w*100)+'%';
  d.style.height=(h.h*100)+'%';
  document.getElementById('videoBox').appendChild(d);
}

function drawWrong(x,y){
  const d=document.createElement('div');
  d.className='wrong-mark';
  d.style.left=(x*100)+'%';
  d.style.top =(y*100)+'%';
  document.getElementById('videoBox').appendChild(d);
}

function evaluate(){
  evaluated = true;
  document.getElementById('overlay').style.display = 'none';

  // HIỂN THỊ TOÀN BỘ ĐÁP ÁN
  hazardData.forEach(h=>{
    if(!h.shown){
      drawCorrect(h);
      h.shown = true;
    }
  });

  const r = document.getElementById('result');
  if(found === hazardData.length){
    r.style.color='green';
    r.innerHTML='✅ ĐÃ NHẬN DIỆN ĐỦ MỐI NGUY';
  }else{
    r.style.color='red';
    r.innerHTML=`❌ CHỈ PHÁT HIỆN ${found}/${hazardData.length} MỐI NGUY`;
  }

  // ⏱️ GIỮ ĐÁP ÁN 5 GIÂY
  setTimeout(()=>{
    clearAllMarks();
    r.innerHTML = '';
    player.playVideo();
  }, 5000);
}
  function clearAllMarks(){
  document.querySelectorAll('.correct-box').forEach(e=>e.remove());
  document.querySelectorAll('.wrong-mark').forEach(e=>e.remove());
}
}
</script>

</body>
</html>

