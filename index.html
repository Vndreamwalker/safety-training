<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Đào tạo nhận diện mối nguy</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f5f5f5;
  padding:15px;
}

h1 { text-align:center }

.video-wrapper {
  position:relative;
  max-width:800px;
  margin:auto;
  background:#000;
  border:3px solid #333;
}

#player {
  width:100%;
  aspect-ratio:16/9;
}

/* lớp bắt click */
#click-layer {
  position:absolute;
  inset:0;
  cursor:crosshair;
  display:none;
}

/* vùng chọn */
#select-box {
  position:absolute;
  width:120px;
  height:120px;
  border:3px solid #007bff;
  background:rgba(0,123,255,.25);
  pointer-events:none;
  display:none;
}

/* mối nguy thật */
.hazard {
  position:absolute;
  border:3px dashed red;
  background:rgba(255,0,0,.25);
  display:none;
}

.hazard.correct {
  border-color:lime;
  background:rgba(0,255,0,.3);
}

/* hiệu ứng kết quả */
.flash-green {
  animation: greenFlash 0.4s 4;
}
.flash-red {
  animation: redFlash 0.4s 4;
}

@keyframes greenFlash {
  0%{background:#000}
  50%{background:#1cff1c}
  100%{background:#000}
}
@keyframes redFlash {
  0%{background:#000}
  50%{background:#ff2b2b}
  100%{background:#000}
}

.info,.result {
  text-align:center;
  font-size:18px;
  margin-top:10px;
  font-weight:bold;
}
</style>
</head>

<body>

<h1>Nhận diện mối nguy</h1>

<div class="video-wrapper" id="wrapper">
  <div id="player"></div>
  <div id="click-layer"></div>
  <div id="select-box"></div>

  <!-- MỐI NGUY -->
  <div class="hazard" data-id="1"
    style="top:120px;left:90px;width:150px;height:120px"></div>

  <div class="hazard" data-id="2"
    style="top:240px;left:360px;width:160px;height:130px"></div>
</div>

<div class="info">
  Lượt chọn: <span id="tries">0</span> / 2
</div>
<div class="result" id="result"></div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
let player;
const START = 20;
const STOP = 30;
const MAX_TRIES = 2;
const BOX = 120;

let tries = 0;
let hits = new Set();

const wrapper = document.getElementById('wrapper');
const clickLayer = document.getElementById('click-layer');
const selectBox = document.getElementById('select-box');
const hazards = document.querySelectorAll('.hazard');

function onYouTubeIframeAPIReady(){
  player = new YT.Player('player',{
    videoId:'fXYMaqxx2sY',
    events:{ onReady:onReady }
  });
}

function onReady(){
  player.seekTo(START,true);
  player.playVideo();

  const t = setInterval(()=>{
    if(player.getCurrentTime()>=STOP){
      player.pauseVideo();
      clickLayer.style.display='block';
      clearInterval(t);
    }
  },200);
}

/* xử lý click + touch */
clickLayer.addEventListener('pointerdown', e=>{
  if(tries>=MAX_TRIES) return;

  tries++;
  document.getElementById('tries').innerText = tries;

  const rect = clickLayer.getBoundingClientRect();
  const x = e.clientX - rect.left - BOX/2;
  const y = e.clientY - rect.top  - BOX/2;

  selectBox.style.left = x+'px';
  selectBox.style.top  = y+'px';
  selectBox.style.display='block';

  hazards.forEach(h=>{
    const hx = h.offsetLeft;
    const hy = h.offsetTop;
    const hw = h.offsetWidth;
    const hh = h.offsetHeight;

    if(
      x+BOX > hx &&
      x < hx+hw &&
      y+BOX > hy &&
      y < hy+hh
    ){
      hits.add(h.dataset.id);
    }
  });

  if(tries===MAX_TRIES){
    setTimeout(checkResult,800);
  }
});

function checkResult(){
  clickLayer.style.display='none';
  selectBox.style.display='none';

  hazards.forEach(h=>{
    h.style.display='block';
    if(hits.has(h.dataset.id)) h.classList.add('correct');
  });

  const result = document.getElementById('result');

  if(hits.size === hazards.length){
    wrapper.classList.add('flash-green');
    result.style.color='green';
    result.innerHTML='✅ Chúc mừng! Bạn đã dừng được tai nạn';
    player.stopVideo();
  } else {
    wrapper.classList.add('flash-red');
    result.style.color='red';
    result.innerHTML='❌ Tai nạn sắp xảy ra!';
    player.playVideo();
  }
}
</script>

</body>
</html>
