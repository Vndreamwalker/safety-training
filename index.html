<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Đào tạo nhận diện mối nguy</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f5f5f5;
    padding: 20px;
  }

  h1 {
    text-align: center;
    font-size: 20px;
  }

  .video-wrapper {
    position: relative;
    width: 800px;
    max-width: 100%;
    margin: auto;
    border: 3px solid #333;
    background: #000;
    aspect-ratio: 16 / 9;
  }

  #player {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .hazard {
    position: absolute;
    border: 2px dashed red;
    background: rgba(255, 0, 0, 0.25);
    cursor: pointer;
    display: none;
    z-index: 5;
  }

  .hazard.clicked {
    border-color: green;
    background: rgba(0, 200, 0, 0.35);
  }

  .info, .result {
    text-align: center;
    margin-top: 15px;
    font-size: 18px;
    font-weight: bold;
  }
</style>
</head>

<body>

<h1>
  Video sẽ tạm dừng để người chơi xác định các mối nguy nhằm cứu nhân vật.
  Nếu không phát hiện đủ mối nguy, tai nạn sẽ tiếp diễn.<br>
  <em>The video pauses for players to spot hazards and save the character.
  If not enough hazards are identified, the accident will continue.</em>
</h1>

<div class="video-wrapper" id="videoWrapper">
  <div id="player"></div>

  <!-- 6 MỐI NGUY (THEO TỶ LỆ) -->
  <div class="hazard" data-x="0.472" data-y="0.562" data-w="0.206" data-h="0.213"></div>
  <div class="hazard" data-x="0.701" data-y="0.665" data-w="0.060" data-h="0.145"></div>
  <div class="hazard" data-x="0.807" data-y="0.461" data-w="0.032" data-h="0.103"></div>
  <div class="hazard" data-x="0.791" data-y="0.550" data-w="0.206" data-h="0.225"></div>
  <div class="hazard" data-x="0.684" data-y="0.272" data-w="0.107" data-h="0.351"></div>
  <div class="hazard" data-x="0.491" data-y="0.127" data-w="0.104" data-h="0.257"></div>
</div>

<div class="info">
  Mối nguy đã phát hiện: <span id="count">0</span> / <span id="total">0</span>
</div>

<div class="result" id="result"></div>

<script src="https://www.youtube.com/iframe_api"></script>

<script>
let player;
const START_TIME = 20;
const STOP_TIME = 30;

const hazards = document.querySelectorAll('.hazard');
const totalHazards = hazards.length;
let found = 0;
let evaluated = false;

document.getElementById('total').innerText = totalHazards;

/* RENDER HAZARD THEO TỶ LỆ */
function renderHazards() {
  const wrapper = document.getElementById('videoWrapper');
  const w = wrapper.clientWidth;
  const h = wrapper.clientHeight;

  hazards.forEach(hz => {
    hz.style.left   = hz.dataset.x * w + 'px';
    hz.style.top    = hz.dataset.y * h + 'px';
    hz.style.width  = hz.dataset.w * w + 'px';
    hz.style.height = hz.dataset.h * h + 'px';
  });
}

window.addEventListener('resize', renderHazards);

/* YOUTUBE */
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    videoId: 'fXYMaqxx2sY',
    playerVars: { controls: 1 },
    events: {
      onReady: onPlayerReady,
      onStateChange: onPlayerStateChange
    }
  });
}

function onPlayerReady() {
  player.playVideo();
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    checkTime();
  }
}

function checkTime() {
  const interval = setInterval(() => {
    if (!player || evaluated) return;

    if (player.getCurrentTime() >= START_TIME &&
        player.getCurrentTime() < STOP_TIME) {

      player.pauseVideo();
      renderHazards();
      showHazards();
      clearInterval(interval);
    }
  }, 300);
}

function showHazards() {
  hazards.forEach(h => h.style.display = 'block');
}

/* CLICK MỐI NGUY */
hazards.forEach(hazard => {
  hazard.addEventListener('click', function () {
    if (!this.classList.contains('clicked')) {
      this.classList.add('clicked');
      found++;
      document.getElementById('count').innerText = found;
    }
  });
});

/* ĐÁNH GIÁ */
function evaluateResult() {
  evaluated = true;
  const result = document.getElementById('result');

  if (found === totalHazards) {
    result.style.color = 'green';
    result.innerHTML = "✅ ĐÁNH GIÁ ĐÚNG – NGĂN CHẶN ĐƯỢC TAI NẠN";
    player.stopVideo();
  } else {
    result.style.color = 'red';
    result.innerHTML = "❌ ĐÁNH GIÁ CHƯA ĐỦ – TAI NẠN XẢY RA";
    hazards.forEach(h => h.style.display = 'none');
    player.playVideo();
  }
}

setInterval(() => {
  if (!evaluated && found === totalHazards) {
    evaluateResult();
  }
}, 500);
</script>

</body>
</html>
