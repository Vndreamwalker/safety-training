<script>
let player;

const START_TIME = 20;
const STOP_TIME  = 30;
const MAX_TRIES  = 2;

let tries = 0;
let evaluated = false;

const hazards    = document.querySelectorAll('.hazard');
const clickLayer = document.getElementById('click-layer');
const userSelect = document.getElementById('userSelect');
const flashBox   = document.getElementById('flash');
const messageBox = document.getElementById('message');

/* render hazard theo % */
function renderHazards() {
  const w = clickLayer.clientWidth;
  const h = clickLayer.clientHeight;

  hazards.forEach(hz => {
    hz.style.left   = hz.dataset.x * w + 'px';
    hz.style.top    = hz.dataset.y * h + 'px';
    hz.style.width  = hz.dataset.w * w + 'px';
    hz.style.height = hz.dataset.h * h + 'px';
  });
}
window.addEventListener('resize', renderHazards);

/* YouTube */
function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    videoId: 'fXYMaqxx2sY',
    playerVars: { controls: 1, rel: 0 },
    events: { onReady: onPlayerReady }
  });
}

function onPlayerReady() {
  renderHazards();
  player.seekTo(START_TIME, true);
  player.playVideo();

  const timer = setInterval(() => {
    if (player.getCurrentTime() >= STOP_TIME) {
      player.pauseVideo();
      clickLayer.style.display = 'block';
      clearInterval(timer);
    }
  }, 200);
}

/* hiá»‡u á»©ng */
function flash(type, text) {
  flashBox.className = 'flash ' + type;
  messageBox.innerText = text;

  flashBox.style.display = 'block';
  messageBox.style.display = 'block';

  setTimeout(() => {
    flashBox.style.display = 'none';
    messageBox.style.display = 'none';
  }, 1500);
}

/* xá»­ lÃ½ click */
clickLayer.addEventListener('pointerdown', e => {
  if (evaluated || tries >= MAX_TRIES) return;

  tries++;
  document.getElementById('tries').innerText = tries;

  const rect = clickLayer.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;

  let hit = false;

  hazards.forEach(hz => {
    const hx = +hz.dataset.x;
    const hy = +hz.dataset.y;
    const hw = +hz.dataset.w;
    const hh = +hz.dataset.h;

    if (x >= hx && x <= hx + hw && y >= hy && y <= hy + hh) {
      hit = true;
      hz.classList.add('correct');
    }
  });

  /* SAU KHI ÄÃNH GIÃ â†’ má»›i hiá»‡n vÃ¹ng chá»n */
  userSelect.style.left = (x * 100 - 12.5) + '%';
  userSelect.style.top  = (y * 100 - 12.5) + '%';
  userSelect.style.display = 'block';

  if (hit) {
    evaluated = true;
    clickLayer.style.display = 'none';
    hazards.forEach(h => h.style.display = 'block');
    flash('success', 'ðŸŽ‰ ChÃºc má»«ng báº¡n Ä‘Ã£ dá»«ng Ä‘Æ°á»£c tai náº¡n');
    player.stopVideo();
  } else {
    flash('fail', 'âš ï¸ Tai náº¡n sáº¯p xáº£y ra');

    if (tries >= MAX_TRIES) {
      clickLayer.style.display = 'none';
      hazards.forEach(h => h.style.display = 'block');
    }
  }
});
</script>
